version: 2.1
# Reusable CircleCI orbs for Node.js and AWS CLI
orbs:
  node: circleci/node@4.2.0
  aws-cli: circleci/aws-cli@2.0.0
jobs:
# Frontend build and deployment job
  frontend:
    working_directory: ~/app/udagram-frontend
    executor: node/default
    steps:
      - checkout:
          path: ~/app
      # Install frontend dependencies
      - node/install-packages:
          app-dir: ~/app/udagram-frontend
      # Build Angular frontend
      - run:
          name: Build Frontend
          command: npm run build
      # Install AWS CLI to deploy frontend
      - aws-cli/install
      # Configure AWS credentials from CircleCI environment variables
      - run:
          name: Configure AWS Profile
          command: |
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID --profile swaves
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY --profile swaves
            aws configure set aws_session_token $AWS_SESSION_TOKEN --profile swaves
            aws configure set region $AWS_REGION --profile swaves
      # Upload frontend build to S3    
      - run:
          name: Deploy Frontend
          command: |
            aws s3 cp --recursive ./www s3://frontend-udacity-bucket765354364542 --profile swaves
  # Backend API build and deployment job
  server:
    working_directory: ~/app/udagram-api
    executor: node/default
    steps:
      - checkout:
          path: ~/app
      # Install backend dependencies
      - run:
          name: Install NPM packages
          command: npm install
          working_directory: ~/app/udagram-api
      # Build backend and create deployable archive
      - run:
          name: Build and Archive Server
          command: |-
            npm run build
            printenv > www/.env
            zip -r www/Archive.zip www
      # Install AWS CLI for backend deployment
      - aws-cli/install
      # Configure AWS credentials securely
      - run:
          name: Configure AWS Profile
          command: |
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID --profile swaves
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY --profile swaves
            aws configure set aws_session_token $AWS_SESSION_TOKEN --profile swaves
            aws configure set region us-east-1 --profile swaves
      # Send secrets from CircleCI to Elastic Beanstalk
      - run:
    name: Set Elastic Beanstalk Environment Variables
    command: |
      aws elasticbeanstalk update-environment \
        --environment-name Demo-app-env \
        --option-settings \
          Namespace=aws:elasticbeanstalk:application:environment,OptionName=POSTGRES_USERNAME,Value=$POSTGRES_USERNAME \
          Namespace=aws:elasticbeanstalk:application:environment,OptionName=POSTGRES_PASSWORD,Value=$POSTGRES_PASSWORD \
          Namespace=aws:elasticbeanstalk:application:environment,OptionName=POSTGRES_DB,Value=$POSTGRES_DB \
          Namespace=aws:elasticbeanstalk:application:environment,OptionName=POSTGRES_HOST,Value=$POSTGRES_HOST \
          Namespace=aws:elasticbeanstalk:application:environment,OptionName=JWT_SECRET,Value=$JWT_SECRET \
        --profile swaves
      # Deploy backend to Elastic Beanstalk
      - run:
          name: Deploy Server
          command: |-        
            aws s3 cp ./www/Archive.zip s3://frontend-udacity-bucket765354364542/Archive.zip --profile swaves
            aws elasticbeanstalk create-application-version --application-name demo-app --version-label <<pipeline.git.revision>> --source-bundle S3Bucket="frontend-udacity-bucket765354364542",S3Key="Archive.zip" --profile swaves
            aws elasticbeanstalk update-environment --application-name demo-app --environment-name Demo-app-env --version-label <<pipeline.git.revision>> --profile swaves

workflows:
  build_and_deploy:
    jobs:
      - frontend:
          filters:
            branches:
              only:
                - main
      - server:
          filters:
            branches:
              only:
                - main